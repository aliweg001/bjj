{% extends "base.html" %}

{% block title %}Techniki - BJJ Techniques Manager{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h2>Wszystkie techniki</h2>
    <a href="{{ url_for('add_technique') }}" class="btn btn-primary">+ Dodaj nowƒÖ technikƒô</a>
</div>

<form method="GET" action="{{ url_for('techniques') }}" style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end;">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="search">Szukaj</label>
            <input type="text" id="search" name="search" value="{{ search_query }}" placeholder="Wpisz nazwƒô lub opis...">
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label for="category">Kategoria</label>
            <select id="category" name="category">
                <option value="">Wszystkie</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" {% if selected_category == cat.id %}selected{% endif %}>
                    {{ cat.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label for="difficulty">Poziom trudno≈õci</label>
            <select id="difficulty" name="difficulty">
                <option value="">Wszystkie</option>
                <option value="easy" {% if selected_difficulty == 'easy' %}selected{% endif %}>≈Åatwy</option>
                <option value="medium" {% if selected_difficulty == 'medium' %}selected{% endif %}>≈öredni</option>
                <option value="hard" {% if selected_difficulty == 'hard' %}selected{% endif %}>Trudny</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Filtruj</button>
    </div>
</form>

<div class="grid">
    {% for technique in techniques %}
    <div class="card" style="cursor: pointer;" onclick="window.location.href='{{ url_for('technique_detail', technique_id=technique.id) }}'">

        <!-- Miniaturka filmu -->
        <div style="margin-bottom: 15px; border-radius: 8px; overflow: hidden; height: 180px; background: #000; position: relative;">
            {% if technique.thumbnail_video %}

                {% if technique.thumbnail_video.video_type == 'youtube' and technique.thumbnail_yt_id %}
                    <!-- Miniaturka YouTube -->
                    <img src="https://img.youtube.com/vi/{{ technique.thumbnail_yt_id }}/mqdefault.jpg"
                         alt="Miniatura YouTube"
                         style="width: 100%; height: 100%; object-fit: cover;">
                    <div class="play-button youtube" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 0, 0, 0.8); color: white; width: 60px; height: 40px; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                        ‚ñ∂
                    </div>

                {% elif technique.thumbnail_video.video_type == 'training' and technique.thumbnail_video.filename %}
                    <!-- Miniaturka uploaded video - POPRAWIONA WERSJA -->
                    <div style="position: relative; width: 100%; height: 100%;">
                        <!-- U≈ºyj bezpo≈õredniego URL z url_for -->
                        {% set video_url = url_for('static', filename='uploads/' + technique.thumbnail_video.filename) %}

                        <!-- DEBUG (mo≈ºesz usunƒÖƒá p√≥≈∫niej) -->
                        <!-- <div style="position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 5px; font-size: 10px; z-index: 10;">
                            {{ technique.thumbnail_video.filename }}
                        </div> -->

                        <video width="100%" height="180"
                               style="object-fit: cover; background: #000;"
                               preload="metadata"
                               playsinline
                               muted
                               onloadeddata="initVideoPreview(this)"
                               poster="{{ url_for('static', filename='img/video-placeholder.jpg') }}">
                            <source src="{{ video_url }}" type="video/mp4">
                            <source src="{{ video_url }}" type="video/avi">
                            <source src="{{ video_url }}" type="video/mov">
                            <source src="{{ video_url }}" type="video/webm">
                            Twoja przeglƒÖdarka nie obs≈Çuguje odtwarzania wideo.
                        </video>
                        <div class="play-button uploaded"
                             style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(102, 126, 234, 0.8); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer;"
                             onclick="playVideoPreview(event, this)">
                            ‚ñ∂
                        </div>
                    </div>

                {% else %}
                    <!-- Inne typy film√≥w -->
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #e8f4fd;">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; color: #3182ce; margin-bottom: 10px;">
                                {% if technique.thumbnail_video.video_type == 'external' %}üåê
                                {% elif technique.thumbnail_video.video_type == 'tutorial' %}üìö
                                {% elif technique.thumbnail_video.video_type == 'seminar' %}üéì
                                {% elif technique.thumbnail_video.video_type == 'competition' %}üèÜ
                                {% else %}üé¨{% endif %}
                            </div>
                            <p style="color: #333; font-size: 14px; margin: 0;">
                                {{ technique.thumbnail_video.video_type|title }}
                            </p>
                            {% if technique.thumbnail_video.original_filename %}
                            <p style="color: #666; font-size: 12px; margin-top: 5px;">
                                {{ technique.thumbnail_video.original_filename|truncate(25, True) }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}

            {% else %}
                <!-- Brak filmu - placeholder -->
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0;">
                    <div style="text-align: center;">
                        <div style="font-size: 48px; color: #ccc; margin-bottom: 10px;">üé¨</div>
                        <p style="color: #999; font-size: 14px; margin: 0;">Brak filmu</p>
                    </div>
                </div>
            {% endif %}
        </div>

        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <h4 style="color: #667eea; margin: 0;">{{ technique.name }}</h4>
            <span class="badge badge-{{ technique.difficulty or 'medium' }}">
                {{ technique.difficulty or 'Medium' }}
            </span>
        </div>

        <p style="color: #666; font-size: 14px; margin-bottom: 15px; line-height: 1.4;">
            {{ technique.description[:120] if technique.description else '' }}{% if technique.description and technique.description|length > 120 %}...{% endif %}
        </p>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
            <div>
                <p style="font-size: 12px; color: #999; margin-bottom: 5px;">
                    Kategoria: <strong>{{ technique.category_name or 'Brak' }}</strong>
                </p>
                <p style="font-size: 12px; color: #999;">
                    Film√≥w: <strong>{{ technique.video_count or 0 }}</strong>
                </p>
            </div>
            <div style="text-align: right;">
                <p style="font-size: 12px; color: #999; margin-bottom: 5px;">Dodane przez:</p>
                <p style="font-size: 12px; color: #333; font-weight: 600;">{{ technique.username or 'System' }}</p>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 12px; color: #999;">
                {% if technique.created_at %}
                    üìÖ {{ technique.created_at.strftime('%Y-%m-%d') }}
                {% endif %}
            </span>
            <a href="{{ url_for('technique_detail', technique_id=technique.id) }}"
               class="btn btn-primary"
               style="padding: 8px 16px; font-size: 14px;"
               onclick="event.stopPropagation();">
                Szczeg√≥≈Çy
            </a>
        </div>
    </div>
    {% else %}
    <div class="card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
        <div style="font-size: 48px; color: #ccc; margin-bottom: 15px;">üîç</div>
        <p style="color: #999; font-size: 16px;">Nie znaleziono technik spe≈ÇniajƒÖcych kryteria wyszukiwania.</p>
        <a href="{{ url_for('techniques') }}" class="btn btn-primary" style="margin-top: 20px;">Wyczy≈õƒá filtry</a>
    </div>
    {% endfor %}
</div>

<style>
    .card {
        transition: transform 0.3s, box-shadow 0.3s;
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .play-button {
        transition: transform 0.2s, background 0.2s;
        cursor: pointer;
    }

    .card:hover .play-button {
        transform: translate(-50%, -50%) scale(1.1);
    }

    .card:hover .play-button.youtube {
        background: rgba(255, 0, 0, 1);
    }

    .card:hover .play-button.uploaded {
        background: rgba(102, 126, 234, 1);
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 25px;
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-easy {
        background: #c6f6d5;
        color: #22543d;
    }

    .badge-medium {
        background: #fed7d7;
        color: #742a2a;
    }

    .badge-hard {
        background: #bee3f8;
        color: #2a4365;
    }

    .btn-primary {
        background: #667eea;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        border: none;
        cursor: pointer;
        font-weight: 600;
        display: inline-block;
        transition: background 0.3s;
    }

    .btn-primary:hover {
        background: #5a67d8;
    }
</style>

<script>
    // Funkcja inicjalizujƒÖca podglƒÖd video
    function initVideoPreview(videoElement) {
        // Spr√≥buj odtworzyƒá pierwsze klatki (wyciszone) dla podglƒÖdu
        videoElement.muted = true;
        videoElement.play().then(() => {
            // Po 1.5 sekundy zatrzymujemy i wracamy na poczƒÖtek
            setTimeout(() => {
                if (!videoElement.paused) {
                    videoElement.pause();
                    videoElement.currentTime = 0;
                }
            }, 1500);
        }).catch(error => {
            console.log('Autoplay nie dzia≈Ça dla podglƒÖdu:', error);
            // Je≈õli autoplay nie dzia≈Ça, poka≈º tylko poster
        });
    }

    // Funkcja do odtwarzania podglƒÖdu po klikniƒôciu przycisku
    function playVideoPreview(event, button) {
        event.stopPropagation();
        event.preventDefault();

        const video = button.closest('div').querySelector('video');
        if (!video) return;

        if (video.paused) {
            video.play();
            button.style.display = 'none';
            video.controls = true;
        } else {
            video.pause();
        }
    }

    // Obs≈Çuga zako≈Ñczenia odtwarzania
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('video').forEach(video => {
            video.addEventListener('ended', function() {
                this.controls = false;
                this.currentTime = 0; // Wr√≥ƒá na poczƒÖtek
                const button = this.closest('div').querySelector('.play-button.uploaded');
                if (button) {
                    button.style.display = 'flex';
                }
            });

            video.addEventListener('pause', function() {
                const button = this.closest('div').querySelector('.play-button.uploaded');
                if (button) {
                    button.style.display = 'flex';
                    this.controls = false;
                }
            });

            // Zapobiegaj klikniƒôciu w video aby nie przej≈õƒá do strony techniki
            video.addEventListener('click', function(e) {
                e.stopPropagation();
                if (this.paused) {
                    this.play();
                    this.controls = true;
                    const button = this.closest('div').querySelector('.play-button.uploaded');
                    if (button) {
                        button.style.display = 'none';
                    }
                } else {
                    this.pause();
                }
            });
        });

        // Inicjalizuj wszystkie video po za≈Çadowaniu strony
        setTimeout(() => {
            document.querySelectorAll('video').forEach(video => {
                if (video.readyState >= 2) { // HAVE_CURRENT_DATA lub wiƒôcej
                    initVideoPreview(video);
                }
            });
        }, 1000);
    });
</script>
{% endblock %}