{% extends "base.html" %}

{% block title %}Dashboard - BJJ Techniques Manager{% endblock %}

{% block content %}
<h2 style="margin-bottom: 30px;">Dashboard</h2>

<!-- Statystyki -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
        <h3 style="font-size: 32px; color: #667eea; margin-bottom: 10px;">{{ total_techniques }}</h3>
        <p style="color: #666; font-size: 14px;">Technik w bazie</p>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
        <h3 style="font-size: 32px; color: #667eea; margin-bottom: 10px;">{{ total_videos }}</h3>
        <p style="color: #666; font-size: 14px;">Film√≥w treningowych</p>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
        <h3 style="font-size: 32px; color: #667eea; margin-bottom: 10px;">{{ categories|length }}</h3>
        <p style="color: #666; font-size: 14px;">Kategorii</p>
    </div>
</div>

<!-- Ostatnie filmy -->
<h3 style="margin-bottom: 20px; color: #333;">Ostatnio dodane filmy</h3>
{% if recent_videos %}
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px;">
    {% for video in recent_videos %}
    <a href="{{ url_for('technique_detail', technique_id=video.technique_id) if video.technique_id else '#' }}"
       style="text-decoration: none; color: inherit; {% if not video.technique_id %}cursor: default;{% endif %}"
       {% if not video.technique_id %}onclick="event.preventDefault();"{% endif %}>
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); {% if video.technique_id %}cursor: pointer; transition: transform 0.3s;{% endif %}"
             {% if video.technique_id %}onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.15)'"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'"{% endif %}>

            <div style="margin-bottom: 10px;">
                <h4 style="margin-bottom: 5px; color: #667eea;">
                    {% if video.technique_name %}
                        {{ video.technique_name }}
                    {% else %}
                        Film #{{ video.id }}
                    {% endif %}
                </h4>
                <p style="font-size: 12px; color: #999;">
                    Typ: <strong>{{ video.video_type }}</strong> |
                    Przes≈Çane przez: <strong>{{ video.uploaded_by_name }}</strong> |
                    Data: <strong>{{ video.uploaded_at.strftime('%Y-%m-%d') if video.uploaded_at else 'Brak daty' }}</strong>
                </p>
            </div>

            <!-- Miniaturka filmu -->
            <div style="position: relative; overflow: hidden; border-radius: 5px; margin-bottom: 15px; height: 180px; background: #f0f0f0;">
                {% if video.video_type == 'youtube' and ('youtube.com' in video.filename or 'youtu.be' in video.filename) %}
                    <!-- YouTube -->
                    {% set yt_id = video.filename.split('v=')[1].split('&')[0] if 'v=' in video.filename else video.filename.split('/')[-1] %}
                    <img src="https://img.youtube.com/vi/{{ yt_id }}/mqdefault.jpg"
                         alt="Miniatura YouTube"
                         style="width: 100%; height: 100%; object-fit: cover;">
                    <div class="play-button youtube" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 0, 0, 0.8); color: white; width: 60px; height: 40px; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                        ‚ñ∂
                    </div>

                {% elif video.video_type == 'training' %}
                    <!-- Uploadowany film - PRAWID≈ÅOWA WERSJA -->
                    {% if video.filename %}
                        <div style="position: relative; width: 100%; height: 100%;">
                            <!-- U≈ºyj bezpo≈õredniego URL -->
                            <video width="100%" height="180"
                                   style="object-fit: cover;"
                                   preload="metadata"
                                   playsinline
                                   muted
                                   poster="{{ url_for('static', filename='img/video-placeholder.jpg') if video_exists else '' }}">
                                <source src="{{ url_for('static', filename='uploads/' + video.filename) }}" type="video/mp4">
                                <source src="{{ url_for('static', filename='uploads/' + video.filename) }}" type="video/avi">
                                <source src="{{ url_for('static', filename='uploads/' + video.filename) }}" type="video/mov">
                                <source src="{{ url_for('static', filename='uploads/' + video.filename) }}" type="video/webm">
                                Twoja przeglƒÖdarka nie obs≈Çuguje odtwarzania wideo.
                            </video>
                            <div class="play-button uploaded" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(102, 126, 234, 0.8); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer;"
                                 onclick="playVideo(event, this)">
                                ‚ñ∂
                            </div>
                        </div>
                    {% else %}
                        <!-- Je≈õli nie ma pliku -->
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; color: #667eea; margin-bottom: 10px;">üé•</div>
                                <p style="color: #333; font-size: 14px; margin: 0;">
                                    {{ video.original_filename|truncate(20, True) if video.original_filename else 'Plik wideo' }}
                                </p>
                            </div>
                        </div>
                    {% endif %}

                {% else %}
                    <!-- Inne typy film√≥w -->
                    <div style="background: #e8f4fd; height: 100%; display: flex; align-items: center; justify-content: center; border-radius: 5px;">
                        <div style="text-align: center;">
                            <span style="font-size: 48px; color: #3182ce; margin-bottom: 10px;">
                                {% if video.video_type == 'external' %}üåê
                                {% elif video.video_type == 'tutorial' %}üìö
                                {% elif video.video_type == 'seminar' %}üéì
                                {% elif video.video_type == 'competition' %}üèÜ
                                {% else %}üé¨{% endif %}
                            </span>
                            <p style="color: #333; font-size: 14px; margin: 0;">
                                {{ video.original_filename|truncate(20, True) if video.original_filename else video.video_type|title }}
                            </p>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Informacja je≈õli nie ma przypisanej techniki -->
            {% if not video.technique_id %}
                <div style="text-align: center; padding: 10px; background: #f7fafc; border-radius: 4px; font-size: 12px; color: #999; border: 1px dashed #ddd; margin-top: 10px;">
                    ‚ö†Ô∏è Nie przypisano do techniki
                </div>
            {% else %}
                <div style="text-align: center; margin-top: 10px;">
                    <span style="background: #667eea; color: white; padding: 8px 16px; border-radius: 4px; font-size: 14px; display: inline-block; font-weight: 600;">
                        üëÅÔ∏è Przejd≈∫ do techniki
                    </span>
                </div>
            {% endif %}
        </div>
    </a>
    {% endfor %}
</div>
{% else %}
<div style="text-align: center; padding: 40px; background: #f7fafc; border-radius: 8px; margin-bottom: 40px;">
    <div style="font-size: 48px; color: #ccc; margin-bottom: 15px;">üé¨</div>
    <p style="color: #999; font-size: 16px; margin-bottom: 10px;">
        Brak dodanych film√≥w
    </p>
    <p style="color: #aaa; font-size: 14px;">
        Dodaj pierwszy film do dowolnej techniki!
    </p>
</div>
{% endif %}
<!-- Kategorie -->
<h3 style="margin-top: 40px; margin-bottom: 20px; color: #333;">Kategorie</h3>
{% if categories %}
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
    {% for category in categories %}
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;"
         onclick="window.location.href='{{ url_for('techniques', category=category.id) }}'"
         onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.15)'"
         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'">

        <h4 style="color: #667eea; margin-bottom: 10px; font-size: 18px;">{{ category.name }}</h4>

        {% if category.description %}
        <p style="color: #666; font-size: 14px; line-height: 1.5;">{{ category.description }}</p>
        {% else %}
        <p style="color: #999; font-size: 14px; font-style: italic;">Brak opisu</p>
        {% endif %}

        <div style="margin-top: 15px; text-align: right;">
            <span style="color: #667eea; font-size: 12px; font-weight: 600;">
                Kliknij aby zobaczyƒá techniki ‚Üí
            </span>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div style="text-align: center; padding: 40px; background: #f7fafc; border-radius: 8px;">
    <div style="font-size: 48px; color: #ccc; margin-bottom: 15px;">üìÇ</div>
    <p style="color: #999; font-size: 16px; margin-bottom: 10px;">
        Brak kategorii
    </p>
    <p style="color: #aaa; font-size: 14px;">
        Dodaj najpierw kategorie!
    </p>
</div>
{% endif %}

<!-- Dodatkowy CSS -->
<style>
    /* Efekt hover dla kart z filmami */
    div[style*="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"]:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    .play-button {
        transition: transform 0.2s, background 0.2s;
        cursor: pointer;
    }

    a:hover .play-button.youtube {
        background: rgba(255, 0, 0, 1);
        transform: translate(-50%, -50%) scale(1.1);
    }

    a:hover .play-button.uploaded {
        background: rgba(102, 126, 234, 1);
        transform: translate(-50%, -50%) scale(1.1);
    }

    /* Responsywno≈õƒá */
    @media (max-width: 768px) {
        div[style*="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));"] {
            grid-template-columns: 1fr;
        }

        div[style*="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));"] {
            grid-template-columns: 1fr;
        }
    }

    /* Styl dla video */
    video {
        background: #000;
    }
</style>

<!-- Skrypt do odtwarzania film√≥w -->
<script>
    // Funkcja do odtwarzania video
    function playVideo(event, button) {
        event.stopPropagation();
        event.preventDefault();

        const video = button.closest('div').querySelector('video');
        if (!video) return;

        if (video.paused) {
            video.play();
            button.style.display = 'none';
            video.controls = true;
        } else {
            video.pause();
        }
    }

    // Obs≈Çuga zako≈Ñczenia odtwarzania
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('video').forEach(video => {
            video.addEventListener('ended', function() {
                this.controls = false;
                const button = this.closest('div').querySelector('.play-button.uploaded');
                if (button) {
                    button.style.display = 'flex';
                }
            });

            video.addEventListener('pause', function() {
                const button = this.closest('div').querySelector('.play-button.uploaded');
                if (button) {
                    button.style.display = 'flex';
                    this.controls = false;
                }
            });

            // Autoplay dla pierwszych kilku klatek (z d≈∫wiƒôkiem wyciszonym)
            video.muted = true;
            video.play().then(() => {
                // Po 2 sekundach pauzujemy
                setTimeout(() => {
                    video.pause();
                    video.currentTime = 0;
                }, 2000);
            }).catch(e => {
                console.log('Autoplay nie dzia≈Ça:', e);
                // Je≈õli autoplay nie dzia≈Ça, poka≈º tylko placeholder
                const button = video.closest('div').querySelector('.play-button.uploaded');
                if (button) {
                    button.style.display = 'flex';
                }
            });
        });
    });
</script>
{% endblock %}